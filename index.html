<!doctype html>
<html>
    <head>
        <title>Lead Manager</title>
	
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
	<script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.10.11/js/jquery.dataTables.js"></script>
        <script src="/socket.io/socket.io.js"></script>
	<link rel="stylesheet" type="text/css" href="//cdn.datatables.net/1.10.11/css/jquery.dataTables.css">
    </head>
    <body onload="showNotificationBtn()">
        <h1>Lead Manager</h1>
	<div id="bottomPanel">
		<table id="history">
			<thead>
				<tr>
					<td datasource="DateAdded">Date</td>
					<td>Country</td>
					<td>Market</td>
					<td>Name</td>
					<td>Company</td>
					<td datasource="TelephoneNumber">Phone</td>
					<td datascource="PhoneValid" defaultVal="<i>No validation</i>">Valid?</td>
					<td>Email</td>
				</tr>
			</thead>
			<tbody>
			</tbody>
		</table>
	</div>
	<style>
		#bottomPanel {
			height: 35%;
			position: fixed;
			bottom: 0%;
			width: 100%;
			border-style: solid;
			border-width: thin;
		}
		#history {
			width: 100%;
		}
		.dataTables_scroll {
			width: 100%;
		}
	</style>
        <button onclick="activateNotifications()" style="display: none;" id="activateNotificationsBtn">Activate notifications</button>
        <script>
            var socket = io();
             $(window).bind('resize', function() {
				$('#history').css('width','100%');
				$('.dataTables_scroll').css('width','100%');
			});
            socket.on('lead notification', function(data){
                var leadData = JSON.parse(data);
                var title = "New " + leadData.Market + (leadData.gotLocation ? " lead in territory" : " lead in unknown territory ") + leadData.UID;
                var leadBody =  'Added: ' + leadData.DateAdded + '\n\
                            ' + (leadData.gotLead ? 'Name: ' + leadData.Name + '\n\
                            Phone: ' + (leadData.PhoneIsCell ? 'Cell-' : '') + leadData.PhoneValid + '-' + leadData.Phone : '') + '\n\
                            Company: ' + leadData.Company + '\n\
                            Email: ' + leadData.Email;
				doNotification(title, leadBody);
				var dataTable = $('#history').DataTable();
				dataTable.row.add(leadData).draw();
            });
            function doNotification(title, leadBody) {
				if (!("Notification" in window)) {
					alert("This browser does not support desktop notification");
				} else if (Notification.permission === "granted") {
					var leadNotification = new Notification(title, {
						body: leadBody
					});
				} else if (Notification.permission !== 'denied') {
					alert("Notifications not activated!");
				};
            };
            function activateNotifications() {
				if (!("Notification" in window)) {
					alert("This browser does not support desktop notification");
				} else if (Notification.permission === "granted") {
					alert("Notifications already activated!");
				} else if (Notification.permission !== 'denied') {
					Notification.requestPermission(function (permission) {
						if (permission === "granted") {
							document.getElementById("activateNotificationsBtn").setAttribute("style", "display: none;");
							alert("Notifications activated!");
						};
					});
				};
			};
			function showNotificationBtn() {
				if ("Notification" in window && Notification.permission!== 'denied' && Notification.permission !== 'granted') {
					document.getElementById("activateNotificationsBtn").setAttribute("style", "");
				};
			};
		$(document).ready( function() {
			var columns = $('#history thead:first td').map(function() {
				if ($(this).attr("datasource") !== undefined && $(this).attr("datasource") !== false) {
					var ret = {
						"data" : $(this).attr("datasource")
					};
				} else {
					var ret = {
						"data" : $(this).text()
					}
				};
				if ($(this).attr("defaultVal") !== undefined && $(this).attr("defaultVal") !== false) {
					ret["defaultContent"] = $(this).attr("defaultVal");
				};
				return ret
			}).get();
			$('#history').DataTable( {
				"columns": columns,
				"lengthChange" : false,
				"pageLength" : 200,
				"scrollY": '100%'
			});
		});
        </script>
    </body>
</html>
