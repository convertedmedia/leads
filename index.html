<!doctype html>
<html>
    <head>
        <title>Lead Manager</title>
    </head>
    <body>
        <h1>Lead Manager</h1>
        <script src="/socket.io/socket.io.js"></script>
        <script>
            var socket = io();
            socket.on('lead notification', function(data){
                var dataJson = JSON.parse(data);
		console.log(dataJson);
                var leadData = dataJson["leadData"];
                var countryKnown = dataJson["countryKnown"];
                if (Notification.permission === "granted") {
                    doLeadNotification(leadData, countryKnown);
                } else if (Notification.permission === "denied") {
                    Notification.requestPermission(function (permission, leadData, countryKnown) {
                        if (!('permission' in Notification)) {
                            Notification.permission = permission;
                        }
                        if (permission === 'granted') {
                            doLeadNotification(leadData, countryKnown);
                        }
                    });
                };
            });
            socket.on(('failed notification'), function(){
                if (Notification.permission === "granted") {
                    doFailedNotification();
                } else if (Notification.permission === "denied") {
                    Notification.requestPermission(function (permission) {
                        if (!('permission' in Notification)) {
                            Notification.permission = permission;
                        }
                        if (permission === 'granted') {
                            doFailedNotification();
                        }
                    });
                };
            });
            function doLeadNotification(leadData, countryKnown) {
		console.log("countryKnown: " + countryKnown);
                var leadNotification = new Notification('New lead in ' + (countryKnown == 'yes' ? '' : 'unknown') + 'territory: ' + leadData.UID, {
                    body :  'Lead Source: ' + leadData.LeadSource + '\n\
                            Name: ' + leadData.Name + '\n\
                            Company: ' + leadData.Company + '\n\
                            Email: ' + leadData.Email + '\n\
                            TelephoneNumber: ' + leadData.Phone
                });
            };
            function doFailedNotification() {
				var failedNotification = new Notification('Failed to fetch new lead');
			};
        </script>
    </body>
</html>
